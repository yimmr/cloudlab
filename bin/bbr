#!/bin/bash

# =================================================================
# 海外非 CN2 线路 Hysteria 2 (UDP/QUIC) 极限性能优化脚本
# Updated: 2026-01
# =================================================================

# 权限检查
[[ $EUID -ne 0 ]] && echo "❌ 错误: 请使用 root 权限运行！" && exit 1

# 定义 sysctl 修改函数
set_sysctl() {
    local key=$1
    local value=$2
    if sysctl "$key" | grep -q "$value"; then
        echo "[跳过] $key 已配置"
    else
        # 彻底清除旧配置避免冲突
        sed -i "/^$key/d" /etc/sysctl.conf
        echo "$key=$value" >> /etc/sysctl.conf
        sysctl -w "$key=$value" > /dev/null 2>&1
        echo "[设置] $key -> $value"
    fi
}

echo "🚀 开始执行 Hysteria 2 专用网络优化..."

# 1. 核心：大幅提升 UDP/TCP 缓冲区上限
# 非 CN2 线路丢包重传多，需要巨大的缓冲空间来维持吞吐量
# 设置为 64MB (67108864 bytes)，这是 Hy2 跑满大带宽的关键
echo "--- 正在调整内核内存缓冲区 ---"
set_sysctl "net.core.rmem_max" "67108864"
set_sysctl "net.core.wmem_max" "67108864"
# 适当提高默认值，服务于未手动申请大内存的辅助进程
set_sysctl "net.core.rmem_default" "2097152"  # 2MB
set_sysctl "net.core.wmem_default" "2097152"  # 2MB

# 2. 拥塞控制与队列调度
# BBR 对 TCP (你访问网站) 依然必不可少；FQ 对平滑数据包发送至关重要
echo "--- 正在优化拥塞控制 (BBR) ---"
set_sysctl "net.core.default_qdisc" "fq"
set_sysctl "net.ipv4.tcp_congestion_control" "bbr"

# 3. 针对 UDP/QUIC 的专项优化
echo "--- 正在优化 UDP 堆栈 ---"
# 增加网络设备积压队列，防止突发流量导致网卡丢包
set_sysctl "net.core.netdev_max_backlog" "50000"
# 允许更多的挂起连接 (虽然主要是 TCP，但高并发场景有益)
set_sysctl "net.core.somaxconn" "65535"
# 开启 MTU 探测，这对非 CN2 线路极其重要，防止因 MTU 黑洞导致的卡死
set_sysctl "net.ipv4.tcp_mtu_probing" "1"
set_sysctl "net.ipv4.tcp_base_mss" "1024"

# 4. TCP 访问侧优化 (服务器 -> 目标网站)
echo "--- 正在优化 TCP 访问性能 ---"
# 允许 TCP 使用最大 64MB 缓冲
set_sysctl "net.ipv4.tcp_rmem" "4096 87380 67108864"
set_sysctl "net.ipv4.tcp_wmem" "4096 65536 67108864"
# 减少 TCP 连接的 bufferbloat (缓冲区膨胀)，降低延迟
set_sysctl "net.ipv4.tcp_notsent_lowat" "16384"
# 开启 TCP Fast Open，加速短连接打开速度
set_sysctl "net.ipv4.tcp_fastopen" "3"
# 禁用空闲后的慢启动，防止空闲后速度瞬间掉底
set_sysctl "net.ipv4.tcp_slow_start_after_idle" "0"
# 快速回收 TIME_WAIT 连接 (视情况，高并发建议开启)
set_sysctl "net.ipv4.tcp_tw_reuse" "1"

# 5. 系统级文件句柄限制 (ULIMIT)
echo "--- 正在优化系统资源限制 ---"
if ! grep -q "soft nofile 1048576" /etc/security/limits.conf; then
    # 备份旧文件
    cp /etc/security/limits.conf /etc/security/limits.conf.bak
    # 删除旧的限制配置 (防止重复)
    sed -i '/soft nofile/d' /etc/security/limits.conf
    sed -i '/hard nofile/d' /etc/security/limits.conf
    sed -i '/soft nproc/d' /etc/security/limits.conf
    sed -i '/hard nproc/d' /etc/security/limits.conf

    cat >> /etc/security/limits.conf << EOF
* soft nofile 1048576
* hard nofile 1048576
* soft nproc 512000
* hard nproc 512000
root soft nofile 1048576
root hard nofile 1048576
EOF
    echo "[设置] 已将文件句柄限制提升至 100万"
else
    echo "[跳过] 文件句柄限制已达标"
fi

# 确保 systemd 服务也生效
sed -i 's/^#DefaultLimitNOFILE=.*/DefaultLimitNOFILE=1048576/' /etc/systemd/system.conf
sed -i 's/^DefaultLimitNOFILE=.*/DefaultLimitNOFILE=1048576/' /etc/systemd/system.conf

# 应用更改
echo "--- 应用内核更改 ---"
sysctl -p > /dev/null 2>&1

echo "=================================================="
echo "✅ 优化完成！建议等其他任务完成后重启服务器"
echo "=================================================="