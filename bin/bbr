#!/bin/bash

# =================================================================
# æµ·å¤–éž CN2 çº¿è·¯ Hysteria 2 (UDP/QUIC) æžé™æ€§èƒ½ä¼˜åŒ–è„šæœ¬
# Updated: 2026-01
# =================================================================

# æƒé™æ£€æŸ¥
[[ $EUID -ne 0 ]] && echo "âŒ é”™è¯¯: è¯·ä½¿ç”¨ root æƒé™è¿è¡Œï¼" && exit 1

# å®šä¹‰ sysctl ä¿®æ”¹å‡½æ•°
set_sysctl() {
    local key=$1
    local value=$2
    if sysctl "$key" | grep -q "$value"; then
        echo "[è·³è¿‡] $key å·²é…ç½®"
    else
        # å½»åº•æ¸…é™¤æ—§é…ç½®é¿å…å†²çª
        sed -i "/^$key/d" /etc/sysctl.conf
        echo "$key=$value" >> /etc/sysctl.conf
        sysctl -w "$key=$value" > /dev/null 2>&1
        echo "[è®¾ç½®] $key -> $value"
    fi
}

echo "ðŸš€æ­£åœ¨å†™å…¥ Hysteria 2 ä¸“å±žä¼˜åŒ–é…ç½®..."

cat > /etc/sysctl.d/99-hy2-optimize.conf << EOF
# æ ¸å¿ƒï¼šUDP/TCP ç¼“å†²åŒº (è°ƒæ•´ä¸º 32MBï¼Œé˜²æ­¢å°å†…å­˜ OOM)
net.core.rmem_max = 26214400
net.core.wmem_max = 26214400
# net.core.rmem_default = 2097152
# net.core.wmem_default = 2097152

# TCP ç¼“å†²åŒºé™åˆ¶
net.ipv4.tcp_rmem = 4096 87380 26214400
net.ipv4.tcp_wmem = 4096 65536 26214400

# æ‹¥å¡žæŽ§åˆ¶ä¸Žé˜Ÿåˆ—
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# UDP/QUIC ä¸“é¡¹ä¼˜åŒ–
net.core.netdev_max_backlog = 50000
net.core.somaxconn = 65535
net.ipv4.tcp_mtu_probing = 1
# net.ipv4.tcp_base_mss = 1024

# é™ä½Žå»¶è¿Ÿä¸Žè¿žæŽ¥ä¼˜åŒ–
net.ipv4.tcp_notsent_lowat = 16384
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_tw_reuse = 1
# net.ipv4.tcp_fastopen = 3
EOF

echo "ðŸš€ æ­£åœ¨è®¾ç½®ç³»ç»Ÿæ–‡ä»¶å¥æŸ„é™åˆ¶ (ULIMIT)..."
# ä¸åŽ»æ”¹ /etc/security/limits.conf ä¸»æ–‡ä»¶ï¼Œè€Œæ˜¯å†™å…¥ç‹¬ç«‹æ–‡ä»¶
cat > /etc/security/limits.d/99-hy2-limits.conf << EOF
* soft nofile 1048576
* hard nofile 1048576
root soft nofile 1048576
root hard nofile 1048576
* soft nproc 512000
* hard nproc 512000
root soft nproc 512000
root hard nproc 512000
EOF
echo "âœ… å·²åˆ›å»º /etc/security/limits.d/99-hy2-limits.conf"

# ç¡®ä¿ systemd æœåŠ¡ä¹Ÿç”Ÿæ•ˆ
sed -i 's/^#DefaultLimitNOFILE=.*/DefaultLimitNOFILE=1048576/' /etc/systemd/system.conf
sed -i 's/^DefaultLimitNOFILE=.*/DefaultLimitNOFILE=1048576/' /etc/systemd/system.conf

sysctl --system

echo "=================================================="
echo "âœ… ä¼˜åŒ–å®Œæˆï¼å»ºè®®ç­‰å…¶ä»–ä»»åŠ¡å®ŒæˆåŽé‡å¯æœåŠ¡å™¨"
echo "=================================================="