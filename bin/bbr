#!/bin/bash

# =================================================================
# æµ·å¤–éž CN2 çº¿è·¯ Hysteria 2 (UDP/QUIC) æžé™æ€§èƒ½ä¼˜åŒ–è„šæœ¬
# Updated: 2026-01
# =================================================================

# 1. æƒé™æ£€æŸ¥
[[ $EUID -ne 0 ]] && echo "âŒ é”™è¯¯: è¯·ä½¿ç”¨ root æƒé™è¿è¡Œï¼" && exit 1

echo "ðŸš€ æ­£åœ¨å†™å…¥ Hysteria 2 ä¸“å±žä¼˜åŒ–é…ç½®..."

# 2. å†™å…¥ Sysctl é…ç½®
# ä½¿ç”¨ cat è¦†ç›–æ¨¡å¼ï¼Œç¡®ä¿é…ç½®å¹²å‡€
cat > /etc/sysctl.d/99-hy2-optimize.conf << EOF
# --- æ ¸å¿ƒï¼šUDP/TCP ç¼“å†²åŒº (é˜²æ­¢å°å†…å­˜ OOM) ---
# å…è®¸åº”ç”¨ç¨‹åºç”³è¯·çš„æœ€å¤§ç¼“å†²åŒº (32MB)
net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
# é…åˆæ ¸å¿ƒç¼“å†²åŒºï¼Œç¨å¾®æå‡ TCP çš„è‡ªåŠ¨è°ƒæ•´èŒƒå›´ (å®‰å…¨å€¼)
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432

# --- UDP/QUIC ä¸“é¡¹ä¼˜åŒ– ---
# å¢žåŠ ç½‘å¡ç§¯åŽ‹é˜Ÿåˆ—ï¼Œé˜²æ­¢ UDP çªå‘æµé‡ä¸¢åŒ…
net.core.netdev_max_backlog = 50000
# å¢žåŠ å¹¶å‘è¿žæŽ¥é˜Ÿåˆ— (è™½ç„¶ Hy2 ç”¨ä¸åˆ°è¿™ä¹ˆå¤šï¼Œä½†é˜²å¤‡é«˜å¹¶å‘æ— å®³)
net.core.somaxconn = 65535

# --- ç³»ç»ŸåŸºç¡€ä¸Žæ‹¥å¡žæŽ§åˆ¶ ---
# å¼€å¯ BBR
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr
# å¼€å¯ IP è½¬å‘ (Docker/ä¸­è½¬ å¿…å¤‡)
net.ipv4.ip_forward = 1
# é…åˆ 100ä¸‡ ulimitï¼Œæå‡ç³»ç»Ÿçº§æ–‡ä»¶æ‰“å¼€ä¸Šé™
fs.file-max = 2097152

# --- ç¼“è§£ SSH å¡é¡¿æˆ–æ–­æµé—®é¢˜ ---
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_slow_start_after_idle = 0

# --- é™ä½Žå»¶è¿Ÿä¸Žè¿žæŽ¥ä¼˜åŒ– (ä½ é€‰æ‹©ä¿ç•™çš„ TCP ä¼˜åŒ–) ---
net.ipv4.tcp_notsent_lowat = 16384
net.ipv4.tcp_tw_reuse = 1
EOF

echo "ðŸš€ æ­£åœ¨è®¾ç½®ç³»ç»Ÿæ–‡ä»¶å¥æŸ„é™åˆ¶ (ULIMIT)..."
# 3. è®¾ç½®ç”¨æˆ·çº§é™åˆ¶
# æ³¨æ„ï¼šè¿™é‡Œè®¾ç½®äº† 100ä¸‡ï¼Œè™½ç„¶æœ‰ç‚¹å¤§ï¼Œä½†åªè¦å†…å­˜å¤Ÿç”¨ä¹Ÿæ²¡é—®é¢˜
cat > /etc/security/limits.d/99-hy2-limits.conf << EOF
* soft nofile 1048576
* hard nofile 1048576
root soft nofile 1048576
root hard nofile 1048576
* soft nproc 512000
* hard nproc 512000
root soft nproc 512000
root hard nproc 512000
EOF
echo "âœ… å·²åˆ›å»º /etc/security/limits.d/99-hy2-limits.conf"

# 4. ç¡®ä¿ Systemd æœåŠ¡é™åˆ¶ç”Ÿæ•ˆ
# ä½¿ç”¨ sed ä¿®æ”¹ system.conf
sed -i 's/^#DefaultLimitNOFILE=.*/DefaultLimitNOFILE=1048576/' /etc/systemd/system.conf
sed -i 's/^DefaultLimitNOFILE=.*/DefaultLimitNOFILE=1048576/' /etc/systemd/system.conf

# 5. åº”ç”¨å†…æ ¸å‚æ•°
sysctl --system

echo "=================================================="
echo "âœ… ä¼˜åŒ–å®Œæˆï¼"
echo "âš ï¸ å®‰è£…å®ŒæˆåŽï¼Œè¯·åŠ¡å¿…é‡å¯æœåŠ¡å™¨ (reboot) ä»¥ç¡®ä¿æ‰€æœ‰è®¾ç½®ç”Ÿæ•ˆï¼"
echo "=================================================="