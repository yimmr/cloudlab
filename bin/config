#!/bin/bash

export LANG=en_US.UTF-8

set -euo pipefail

SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$SCRIPT_DIR/utils.sh"
source "$SCRIPT_DIR/hysteria.sh"

domain=$(prompt "[必填]请输入客户端访问域名: " "")

if [ -z "$domain" ]; then
    echo -e "\033[0;31m未提供域名\033[0m "
    exit 1
fi

cf_token=$(prompt "Cloudflare API令牌（或留空回车跳过申请证书）: " "")

if [ -n "$cf_token" ]; then
    ssl_domain=$(prompt "申请证书的域名（多域名用,分隔）: " "$domain")
    ssl_domain=${ssl_domain:-$domain}
fi

if [ -n "$cf_token" ] && [ -n "$ssl_domain" ]; then
    mail=$(prompt "订阅域名通知的邮箱地址（或留空回车拒绝通知）: " "")
    if [ -n "$mail" ]; then
        mail="-m $mail"
    fi
    echo -e "\033[32m::\033[0m 正在申请证书..."
    rm -rf certbot
    ./bin/cert auto -d $ssl_domain -t $cf_token $mail -r false
    echo -e "\033[32m✓\033[0m 申请证书成功！"
else
    echo -e "\033[32m::\033[0m 已跳过申请证书"
fi

password=$(prompt "请输入客户端访问密码（或留空回车用随机密码）: " "")
if [ -z "$password" ]; then
    password=$(generate_password)
fi

ENV_FILE="$PROJECT_DIR/.env"
DEFAULT_ENV_NAME=".env.def"
DEFAULT_ENV_FILE="$PROJECT_DIR/$DEFAULT_ENV_NAME"


if [ ! -f "$ENV_FILE" ]; then
    echo -e "\033[32m::\033[0m不存在 .env 文件，正在从 $DEFAULT_ENV_NAME 复制..."
    if [ -f "$DEFAULT_ENV_FILE" ]; then
        cp "$DEFAULT_ENV_FILE" "$ENV_FILE"
        echo -e "\033[32m::\033[0m已创建 .env 文件"
    else
        echo -e "\033[31m::\033[0m错误：不存在 $DEFAULT_ENV_NAME 文件"
        exit 1
    fi
fi

HOSTNAME=$domain
VARS=("HOSTNAME")
env_content=$(cat "$ENV_FILE")
echo -e "\033[32m::\033[0m正在更新 .env 文件..."
for var in "${VARS[@]}"; do
    if [ -n "${!var}" ]; then
        escaped_value=$(printf '%s\n' "${!var}" | sed 's:[\/&]:\\&:g')
        env_content=$(echo "$env_content" | sed -E "s/^($var=).*/\1$escaped_value/")
    fi
done
echo "$env_content" > "$ENV_FILE"
echo -e "\033[32m::\033[0m已更新 .env 文件"

# 开始安装

install_hysteria_if

docker compose up -d

configure_hysteria "$domain" "$password" 443 "$PROJECT_DIR/caddy/data/caddy/certificates/local"